import json
from collections import defaultdict

from django.http import HttpResponse
from django.shortcuts import render
from django.views.decorators.csrf import csrf_exempt

from travel_assistant.common.custom_types import ClientContext
from travel_assistant.consultant.assistant import Assistant


def main_page(request):
    return render(request, 'RussPass.html')


context_by_chat_id: dict[str, ClientContext] = defaultdict(ClientContext)
assistant = Assistant(verbose=True)


@csrf_exempt
def form_send_message(request):
    # if this is a POST request we need to process the form data
    if request.method == "POST":
        message_text = request.POST.get("message_text", "")
        csrf = request.POST.get("csrf", "")

        # Обращение к боту
        old_context = context_by_chat_id[csrf]
        new_context_by_chat_id, bot_message, bot_question, options, products = assistant.chat_single(old_context,
                                                                                                    message_text)
        for p, text_p in products:
            p.emb = None
        ready_products = [{'product': dataclasses.asdict(p), 'description': d} for p, d in products]
        response_data = {'message': bot_message + "\n" + bot_question, 'options': options, 'products': ready_products}
        # response_data = {"message": "К сожалению, у меня нет информации о ваших интересах. Могу предложить вам популярные направления туризма в России, такие как Москва, Санкт-Петербург, Золотое Кольцо, Казань, Сочи, Байкал и Алтай. Если вы хотите узнать больше о каком-то конкретном месте или экскурсии, пожалуйста, сообщите мне.\nКакие виды активного отдыха вам интересны?",    "options": [        "Сплав по реке",        "Пеший поход в горы",        "Скалолазание",        "Сноубординг",        "Катание на лыжах"    ],    "products": [        {            "product": {                "id": "5e5e6903ccb7de00197f8abd",                "title": "Пешая прогулка St. Petersburg Free Tour",                "description": "<p>Обзорная экскурсия от компании St. Petersburg Free Tour охватывает главные достопримечательности города и является одной из популярных среди путешественников Санкт-Петербурга.Маршрут включает Дворцовую площадь, Невский проспект, прилегающие территории Адмиралтейства, Исаакиевского собора, памятника Петру I, Строгановского дворца и храма Спас на Крови.</p>",                "cities": [                    "Санкт-Петербург"                ],                "regions": [                    "Санкт-Петербург"                ],                "tags": [],                "full_text": "Пешая прогулка St. Petersburg Free Tour. Город: Санкт-Петербург, регион: Санкт-Петербург. Теги: . <p>Обзорная экскурсия от компании St. Petersburg Free Tour охватывает главные достопримечательности города и является одной из популярных среди путешественников Санкт-Петербурга.Маршрут включает Дворцовую площадь, Невский проспект, прилегающие территории Адмиралтейства, Исаакиевского собора, памятника Петру I, Строгановского дворца и храма Спас на Крови.</p>",                "emb": None            },            "description": "Пешая прогулка St. Petersburg Free Tour может понравиться вам, потому что это бесплатная обзорная экскурсия по Санкт-Петербургу, которая позволяет увидеть главные достопримечательности города. Маршрут включает Дворцовую площадь, Невский проспект, прилегающие территории Адмиралтейства, Исаакиевского собора, памятника Петру I, Строгановского дворца и храма Спас на Крови. Вы сможете насладиться красотой и историей этих мест, а также получить информацию от опытного гида."        },        {            "product": {                "id": "65d48c7548d1c679b45eaa0c",                "title": "Aikko",                "description": "<p>Здравствуйте, я еду в небольшой сольный тур, так что это прекрасный повод увидеться. Будем петь мои самые популярные и новые, ещё невышедшие, песни, будем заряжаться друг от друга энергией и жить свою жизнь дальше. Это не богема тур, но тоже приходите на концерт!</p>",                "cities": [                    "Москва",                    "Санкт-Петербург",                    "Нижний Новгород",                    "Екатеринбург",                    "Ростов-на-Дону",                    "Краснодар",                    "Новосибирск",                    "Тюмень",                    "Самара",                    "Казань",                    "городской округ Красноярск",                    "городской округ Воронеж"                ],                "regions": [                    "Санкт-Петербург",                    "Москва",                    "Республика Татарстан",                    "Краснодарский край",                    "Нижегородская область",                    "Ростовская область",                    "Самарская область",                    "Свердловская область",                    "Тюменская область",                    "Новосибирская область",                    "городской округ Красноярск",                    "городской округ Воронеж"                ],                "tags": [],                "full_text": "Aikko. Город: Москва, Санкт-Петербург, Нижний Новгород, Екатеринбург, Ростов-на-Дону, Краснодар, Новосибирск, Тюмень, Самара, Казань, городской округ Красноярск, городской округ Воронеж, регион: Санкт-Петербург, Москва, Республика Татарстан, Краснодарский край, Нижегородская область, Ростовская область, Самарская область, Свердловская область, Тюменская область, Новосибирская область, городской округ Красноярск, городской округ Воронеж. Теги: . <p>Здравствуйте, я еду в небольшой сольный тур, так что это прекрасный повод увидеться. Будем петь мои самые популярные и новые, ещё невышедшие, песни, будем заряжаться друг от друга энергией и жить свою жизнь дальше. Это не богема тур, но тоже приходите на концерт!</p>",                "emb": None            },            "description": "Aikko - это город, который предлагает множество возможностей для отдыха и развлечений. Здесь вы сможете насладиться красивыми пейзажами, посетить исторические места и музеи, попробовать местную кухню и провести время на природе. Кроме того, в городе есть много магазинов, ресторанов и кафе, где вы сможете насладиться вкусной едой и напитками. Также здесь проводятся различные культурные мероприятия, концерты и фестивали, которые помогут вам познакомиться с местной культурой и традициями. В общем, Aikko - это место, где каждый найдет что-то по своему вкусу."        },        {            "product": {                "id": "65912cbfce5cce8c129a0b6e",                "title": "Vspak",                "description": "<p>Атмосферный, чувственный и загадочный исполнитель Vspak уже в твоём городе!<br><br>Vspak отправляется в концертный тур «Чацкий Саша», где исполнит свои самые главных хиты, а в перерывах между песнями будет читать собственную текстовую поэзию с нового сборника стихов!<br><br>На своих концертах Vspak создаёт максимально уютную и ламповую обстановку. Каждый Лис получает лучи внимания и возможность исполнить с исполнителем свои любимые треки.<br><br>Мы не сомневаемся, что концерт оставит в вашем сердце память на всю жизнь, подарит незабываемые эмоции, которые будут согревать вас в грустные периоды!<br><br>Ждём тебя на концерте!<br><br>Автограф-сессия для обладателей билетов категории Meet &amp; Greet начинается за 2 часа до концерта.<br>Продолжительность автограф-сессии: 1—1,5 часа.<br><br>Открытие дверей для посетителей с категорией билетов «Стандарт» за 30 минут до начала.</p>",                "cities": [                    "Москва",                    "Санкт-Петербург",                    "Кемерово",                    "Новокузнецк",                    "Барнаул",                    "Тверь",                    "Томск"                ],                "regions": [                    "Санкт-Петербург",                    "Москва",                    "Алтайский край",                    "Кемеровская область",                    "Тверская область",                    "Томская область"                ],                "tags": [],                "full_text": "Vspak. Город: Москва, Санкт-Петербург, Кемерово, Новокузнецк, Барнаул, Тверь, Томск, регион: Санкт-Петербург, Москва, Алтайский край, Кемеровская область, Тверская область, Томская область. Теги: . <p>Атмосферный, чувственный и загадочный исполнитель Vspak уже в твоём городе!<br><br>Vspak отправляется в концертный тур «Чацкий Саша», где исполнит свои самые главных хиты, а в перерывах между песнями будет читать собственную текстовую поэзию с нового сборника стихов!<br><br>На своих концертах Vspak создаёт максимально уютную и ламповую обстановку. Каждый Лис получает лучи внимания и возможность исполнить с исполнителем свои любимые треки.<br><br>Мы не сомневаемся, что концерт оставит в вашем сердце память на всю жизнь, подарит незабываемые эмоции, которые будут согревать вас в грустные периоды!<br><br>Ждём тебя на концерте!<br><br>Автограф-сессия для обладателей билетов категории Meet &amp; Greet начинается за 2 часа до концерта.<br>Продолжительность автограф-сессии: 1—1,5 часа.<br><br>Открытие дверей для посетителей с категорией билетов «Стандарт» за 30 минут до начала.</p>",                "emb": None            },            "description": "Концерт Vspak - это уникальная возможность насладиться атмосферным исполнением чувственных и загадочных песен, а также получить незабываемые эмоции от чтения авторской поэзии. Уютная и ламповая обстановка на концерте позволит каждому слушателю почувствовать себя особенным и получить внимание исполнителя. Автограф-сессия для обладателей билетов категории Meet & Greet добавит дополнительный уровень интерактивности и позволит получить памятные сувениры."        },        {            "product": {                "id": "658e936def1ab4891a4e8cd1",                "title": "Trip to Balagan",                "description": "<p>Есть только одна ночь, где параллельные измерения все таки пересекутся в мощнейшей коллаборации этой весны в преддверии самого масштабного фестиваля России, создав новую благородную историю твоего отдыха. Делаем глубокий вдох: Trip и Balagan. То, что живет внутри нас, вдохновляет, удивляет и отправляет в увлекательное путешествие между мирами, где стираются видимые и невидимые границы твоего сознания, а балом правит сюрреализм и квинтэссенция звуков. Choose your Trip to Balagan!</p>",                "cities": [                    "Москва"                ],                "regions": [                    "Москва"                ],                "tags": [],                "full_text": "Trip to Balagan. Город: Москва, регион: Москва. Теги: . <p>Есть только одна ночь, где параллельные измерения все таки пересекутся в мощнейшей коллаборации этой весны в преддверии самого масштабного фестиваля России, создав новую благородную историю твоего отдыха. Делаем глубокий вдох: Trip и Balagan. То, что живет внутри нас, вдохновляет, удивляет и отправляет в увлекательное путешествие между мирами, где стираются видимые и невидимые границы твоего сознания, а балом правит сюрреализм и квинтэссенция звуков. Choose your Trip to Balagan!</p>",                "emb": None            },            "description": "Это место может понравиться вам своей уникальной атмосферой и возможностью погрузиться в мир сюрреализма и музыки. Здесь вы сможете насладиться мощной коллаборацией двух талантливых коллективов, которые создадут новую благородную историю вашего отдыха. Это место также предлагает возможность расширить свое сознание и отправиться в увлекательное путешествие между мирами."        }    ]}
    else:
        response_data = {}
    return HttpResponse(json.dumps(response_data), content_type="application/json")
